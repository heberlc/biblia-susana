---
import Layout from "../layouts/Layout.astro";
import SpeechButton from "../components/SpeechButton.astro";
import { loadBible } from "../lib/loadBible";
import { initializeSearch, buscar } from "../lib/search";
import type { ResultadoBusqueda } from "../types/bible";

// Obtener el par√°metro de b√∫squeda - probando m√∫ltiples formas
const query1 = Astro.url.searchParams.get('q') || '';
const query2 = new URL(Astro.request.url).searchParams.get('q') || '';
const query3 = Astro.params.q || '';

console.log('=== B√öSQUEDA INICIADA ===');
console.log('Astro.url:', Astro.url.href);
console.log('Astro.request.url:', Astro.request.url);
console.log('Astro.url.searchParams:', Array.from(Astro.url.searchParams.entries()));
console.log('Query m√©todo 1 (Astro.url):', query1);
console.log('Query m√©todo 2 (new URL):', query2);
console.log('Query m√©todo 3 (Astro.params):', query3);

const query = query1 || query2 || query3;

let resultados: ResultadoBusqueda[] = [];
let error = false;
let errorMessage = '';

if (query.trim()) {
  try {
    console.log('Cargando Biblia...');
    const biblia = await loadBible();
    console.log('Biblia cargada, libros:', biblia.libros.length);
    console.log('Primer libro:', biblia.libros[0]?.nombre);
    console.log('Estructura del primer libro:', JSON.stringify(biblia.libros[0], null, 2).substring(0, 500));
    
    initializeSearch(biblia);
    console.log('B√∫squeda inicializada');
    
    resultados = buscar(query);
    console.log('Resultados encontrados:', resultados.length);
    if (resultados.length > 0) {
      console.log('Primer resultado:', JSON.stringify(resultados[0], null, 2));
    }
  } catch (e) {
    console.error('Error en la b√∫squeda:', e);
    errorMessage = e instanceof Error ? e.message : String(e);
    error = true;
  }
} else {
  console.log('Query vac√≠a, no se ejecuta b√∫squeda');
}
---

<Layout 
  title={`Buscar: ${query} - Biblia Accesible`}
  description={`Resultados de b√∫squeda para "${query}" en la Biblia`}
>
  <div class="max-w-5xl mx-auto">
    <!-- Formulario de b√∫squeda -->
    <section class="mb-8">
      <form action="/buscar" method="get" class="mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <label for="searchInput" class="sr-only">Buscar en la Biblia</label>
          <input
            type="search"
            id="searchInput"
            name="q"
            value={query}
            placeholder="Buscar vers√≠culos..."
            class="flex-1 px-6 py-4 text-xl border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-300 transition-colors"
            required
            autofocus
          />
          <button
            type="submit"
            class="btn-large bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors shadow-lg px-8"
          >
            <span class="text-2xl mr-2" aria-hidden="true">üîç</span>
            Buscar
          </button>
        </div>
      </form>

      <div class="flex justify-center gap-4">
        <a
          href="/"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 transition-colors font-semibold text-lg"
        >
          <span class="text-xl" aria-hidden="true">üè†</span>
          Volver al Inicio
        </a>
      </div>
    </section>

    <!-- Resultados -->
    {error && (
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg" role="alert">
        <p class="font-bold text-xl mb-2">Error en la b√∫squeda</p>
        <p class="text-lg mb-2">No se pudo realizar la b√∫squeda. Intenta de nuevo.</p>
        {errorMessage && (
          <p class="text-sm font-mono bg-red-200 p-2 rounded mt-2">{errorMessage}</p>
        )}
      </div>
    )}

    {!error && query.trim() && (
      <section>
        <h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100">
          {resultados.length > 0 
            ? `${resultados.length} resultado${resultados.length !== 1 ? 's' : ''} para "${query}"`
            : `No se encontraron resultados para "${query}"`
          }
        </h2>

        {resultados.length > 0 ? (
          <div class="space-y-6">
            {resultados.map((resultado) => (
              <article class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow border-l-4 border-blue-500 dark:border-blue-400">
                <header class="mb-4">
                  <h3 class="text-xl font-bold text-blue-700 dark:text-blue-400">
                    <a 
                      href={`/libro/${encodeURIComponent(resultado.libro)}/${resultado.capitulo}`}
                      class="hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
                    >
                      {resultado.libro} {resultado.capitulo}:{resultado.versiculo}
                    </a>
                  </h3>
                </header>
                
                <p class="text-lg text-gray-800 dark:text-gray-200 mb-4 leading-relaxed">
                  {resultado.texto}
                </p>

                <div class="flex gap-4">
                  <SpeechButton 
                    text={`${resultado.libro} ${resultado.capitulo} ${resultado.versiculo}. ${resultado.texto}`}
                    label="Escuchar"
                    className="text-base"
                  />
                  <a
                    href={`/libro/${encodeURIComponent(resultado.libro)}/${resultado.capitulo}`}
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 focus:ring-4 focus:ring-blue-300 transition-colors font-semibold"
                  >
                    Ver cap√≠tulo completo
                  </a>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-6 rounded-lg">
            <p class="font-bold text-xl mb-2">Sin resultados</p>
            <p class="text-lg">
              Intenta con otros t√©rminos de b√∫squeda o verifica la ortograf√≠a.
            </p>
          </div>
        )}
      </section>
    )}

    {!query.trim() && (
      <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg text-center">
        <p class="font-bold text-xl mb-2">B√∫squeda en la Biblia</p>
        <p class="text-lg">
          Ingresa un t√©rmino para buscar en todos los vers√≠culos de la Biblia.
        </p>
      </div>
    )}
  </div>
</Layout>

<style>
  article {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    article {
      animation: none;
    }
  }
</style>
