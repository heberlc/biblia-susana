---
import Layout from "../../../layouts/Layout.astro";
import SpeechButton from "../../../components/SpeechButton.astro";
import ChapterSpeechButton from "../../../components/ChapterSpeechButton.astro";
import { loadBible } from "../../../lib/loadBible";
import type { Libro, Capitulo } from "../../../types/bible";

// Generar rutas est치ticas para todos los cap칤tulos de todos los libros
export async function getStaticPaths() {
  const biblia = await loadBible();
  const paths = [];
  
  for (const libro of biblia.libros) {
    for (const capitulo of libro.capitulos) {
      paths.push({
        params: { 
          nombre: libro.nombre,
          capitulo: capitulo.numero.toString()
        },
      });
    }
  }
  
  return paths;
}

// Obtener par치metros de la URL
const { nombre, capitulo: capituloNumStr } = Astro.params;
const capituloNum = parseInt(capituloNumStr || '1', 10);

let libro: Libro | undefined;
let capitulo: Capitulo | undefined;
let error = false;

try {
  const biblia = await loadBible();
  libro = biblia.libros.find(l => l.nombre === nombre);
  if (libro) {
    capitulo = libro.capitulos.find(c => c.numero === capituloNum);
  }
} catch (e) {
  console.error('Error al cargar el cap칤tulo:', e);
  error = true;
}

// Si no se encuentra, redirigir
if ((!libro || !capitulo) && !error) {
  return Astro.redirect('/404');
}

// Cap칤tulos anterior y siguiente para navegaci칩n
const capituloAnterior = libro && capituloNum > 1 ? capituloNum - 1 : null;
const capituloSiguiente = libro && capituloNum < libro.capitulos.length ? capituloNum + 1 : null;
---

<Layout
  title={`${libro?.nombre} ${capituloNum} - Biblia Susana`}
  description={`${libro?.nombre} cap칤tulo ${capituloNum} - Lee vers칤culo por vers칤culo con audio. Biblia Susana`}
>
  <div class="max-w-4xl mx-auto">
    <!-- Navegaci칩n superior -->
    <nav class="mb-8 flex flex-wrap gap-4" aria-label="Navegaci칩n">
      <a
        href="/"
        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 transition-colors font-semibold text-lg"
      >
        <span class="text-xl" aria-hidden="true">游</span>
        Inicio
      </a>
      <a
        href={`/libro/${encodeURIComponent(nombre || '')}`}
        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors font-semibold text-lg"
      >
        <span class="text-xl" aria-hidden="true">游닀</span>
        {libro?.nombre}
      </a>
    </nav>

    {error && (
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg" role="alert">
        <p class="font-bold text-xl mb-2">Error al cargar el cap칤tulo</p>
        <p class="text-lg">No se pudo cargar el contenido. Intenta de nuevo.</p>
      </div>
    )}

    {libro && capitulo && (
      <div>
        <!-- Encabezado del cap칤tulo -->
        <header class="mb-8 text-center bg-blue-50 dark:bg-gray-800 rounded-xl p-6 border-2 border-blue-200 dark:border-blue-800">
          <h1 class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-gray-100 mb-2">
            {libro.nombre} {capituloNum}
          </h1>
          <p class="text-xl text-gray-600 dark:text-gray-300">
            {capitulo.versiculos.length} {capitulo.versiculos.length === 1 ? 'vers칤culo' : 'vers칤culos'}
          </p>
        </header>

        <!-- Bot칩n para leer todo el cap칤tulo -->
        <div class="mb-8 flex justify-center">
          <ChapterSpeechButton 
            text={capitulo.versiculos.map(v => v.texto).join(' ')}
            label="Leer cap칤tulo completo"
          />
        </div>

        <!-- Lista de vers칤culos -->
        <section class="space-y-6 mb-12">
          <h2 class="sr-only">Vers칤culos</h2>
          {capitulo.versiculos.map((versiculo) => (
            <article 
              id={`v${versiculo.numero}`}
              class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow border-l-4 border-blue-500 dark:border-blue-400"
            >
              {versiculo.titulo && (
                <h3 class="text-2xl font-bold text-blue-700 dark:text-blue-400 mb-4 border-b-2 border-blue-200 dark:border-blue-700 pb-2">
                  {versiculo.titulo}
                </h3>
              )}
              <div class="flex items-start gap-4">
                <span class="shrink-0 w-12 h-12 bg-blue-600 dark:bg-blue-700 text-white rounded-full flex items-center justify-center text-xl font-bold" aria-label={`Vers칤culo ${versiculo.numero}`}>
                  {versiculo.numero}
                </span>
                <div class="flex-1">
                  <p class="text-xl text-gray-800 dark:text-gray-200 leading-relaxed mb-4">
                    {versiculo.texto}
                  </p>
                  <SpeechButton 
                    text={`${versiculo.titulo ? versiculo.titulo + '. ' : ''}${libro.nombre} ${capituloNum} ${versiculo.numero}. ${versiculo.texto}`}
                    label="Escuchar vers칤culo"
                    className="text-base"
                  />
                </div>
              </div>
            </article>
          ))}
        </section>

        <!-- Navegaci칩n inferior -->
        <nav class="flex justify-between items-center gap-4 py-8 border-t-2 border-gray-200" aria-label="Navegaci칩n entre cap칤tulos">
          {capituloAnterior ? (
            <a
              href={`/libro/${encodeURIComponent(nombre || '')}/${capituloAnterior}`}
              class="btn-large inline-flex items-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors shadow-lg"
            >
              <span class="text-2xl" aria-hidden="true">拘勇</span>
              <span class="hidden sm:inline">Cap칤tulo {capituloAnterior}</span>
              <span class="sm:hidden">Anterior</span>
            </a>
          ) : (
            <div></div>
          )}

          {capituloSiguiente ? (
            <a
              href={`/libro/${encodeURIComponent(nombre || '')}/${capituloSiguiente}`}
              class="btn-large inline-flex items-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors shadow-lg"
            >
              <span class="hidden sm:inline">Cap칤tulo {capituloSiguiente}</span>
              <span class="sm:hidden">Siguiente</span>
              <span class="text-2xl" aria-hidden="true">俱뫮잺</span>
            </a>
          ) : (
            <div></div>
          )}
        </nav>
      </div>
    )}
  </div>
</Layout>

<style>
  /* Animaci칩n suave para los vers칤culos */
  @media (prefers-reduced-motion: no-preference) {
    article {
      animation: slideUp 0.4s ease-out;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Scroll suave */
  html {
    scroll-behavior: smooth;
  }

  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
  }
</style>
