---
import Layout from "../layouts/Layout.astro";
import LibroCard from "../components/LibroCard.astro";
import VoiceSearch from "../components/VoiceSearch.astro";
import { loadBible } from "../lib/loadBible";
import type { Libro } from "../types/bible";

let libros: Libro[] = [];
let error = false;

try {
  const biblia = await loadBible();
  libros = biblia.libros;
} catch (e) {
  console.error('Error al cargar la Biblia:', e);
  error = true;
}
---

<Layout
  title="Biblia Susana - Lee la Palabra de Dios"
  description="Biblia Susana: Lee y estudia la Biblia con herramientas accesibles. B칰squeda inteligente, lectura en voz alta de vers칤culos y cap칤tulos completos, dise침o claro y f치cil de usar"
>
  <div class="max-w-6xl mx-auto">
    <!-- Secci칩n de b칰squeda -->
    <section class="mb-12 text-center spacing-wide">
            <h2 class="text-4xl font-bold text-center mb-8 text-blue-800 dark:text-blue-400">
        Bienvenido a Biblia Susana
      </h2>
            <p class="text-xl text-center mb-12 text-gray-700 dark:text-gray-300 max-w-3xl mx-auto">
        Lee la Palabra de Dios con herramientas accesibles. Busca, escucha y explora las Escrituras de forma sencilla.
      </p>

      <!-- Formulario de b칰squeda -->
      <form action="/buscar-client" method="get" class="mb-8">
        <div class="flex flex-col md:flex-row gap-4 max-w-3xl mx-auto">
          <label for="searchInput" class="sr-only">Buscar en la Biblia</label>
          <input
            type="search"
            id="searchInput"
            name="q"
            placeholder="Buscar vers칤culos... (ej: amor, fe, esperanza)"
            class="flex-1 px-6 py-4 text-xl border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-300 transition-colors"
            required
          />
          <button
            type="submit"
            class="btn-large bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors shadow-lg px-8"
          >
            <span class="text-2xl mr-2" aria-hidden="true">游댌</span>
            Buscar
          </button>
        </div>
      </form>

      <!-- B칰squeda por voz -->
      <VoiceSearch className="mb-8" />
    </section>

    <!-- Mensaje de error -->
    {error && (
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg mb-8" role="alert">
        <p class="font-bold text-xl mb-2">Error al cargar la Biblia</p>
        <p class="text-lg">
          No se pudo cargar el contenido. Verifica que el archivo 
          <code class="bg-red-200 px-2 py-1 rounded">public/data/biblia.json</code> exista.
        </p>
      </div>
    )}

    <!-- Lista de libros -->
    {!error && libros.length > 0 && (
      <section>
        <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-100 text-center">
          Libros de la Biblia
        </h3>
        
        <!-- Pesta침as -->
        <div class="mb-8">
          <div class="flex justify-center gap-4 flex-wrap">
            <button
              id="tabAT"
              class="tab-button active px-8 py-3 text-lg font-bold rounded-lg transition-colors"
            >
              游닆 Antiguo Testamento
            </button>
            <button
              id="tabNT"
              class="tab-button px-8 py-3 text-lg font-bold rounded-lg transition-colors"
            >
              九뢢잺 Nuevo Testamento
            </button>
          </div>
        </div>

        <!-- Antiguo Testamento -->
        <div id="contentAT" class="tab-content">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {libros.slice(0, 39).map((libro) => (
              <LibroCard
                nombre={libro.nombre}
                numCapitulos={libro.capitulos.length}
                href={`/libro/${encodeURIComponent(libro.nombre)}`}
              />
            ))}
          </div>
        </div>

        <!-- Nuevo Testamento -->
        <div id="contentNT" class="tab-content hidden">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {libros.slice(39).map((libro) => (
              <LibroCard
                nombre={libro.nombre}
                numCapitulos={libro.capitulos.length}
                href={`/libro/${encodeURIComponent(libro.nombre)}`}
              />
            ))}
          </div>
        </div>
      </section>
    )}
  </div>

  <script>
    const tabAT = document.getElementById('tabAT');
    const tabNT = document.getElementById('tabNT');
    const contentAT = document.getElementById('contentAT');
    const contentNT = document.getElementById('contentNT');

    function switchTab(showAT) {
      if (showAT) {
        tabAT?.classList.add('active');
        tabNT?.classList.remove('active');
        contentAT?.classList.remove('hidden');
        contentNT?.classList.add('hidden');
      } else {
        tabAT?.classList.remove('active');
        tabNT?.classList.add('active');
        contentAT?.classList.add('hidden');
        contentNT?.classList.remove('hidden');
      }
    }

    tabAT?.addEventListener('click', () => switchTab(true));
    tabNT?.addEventListener('click', () => switchTab(false));
  </script>
</Layout>

<style>
  .tab-button {
    background: #e5e7eb;
    color: #374151;
  }

  .dark .tab-button {
    background: #374151;
    color: #e5e7eb;
  }

  .tab-button.active {
    background: #2563eb;
    color: white;
  }

  .dark .tab-button.active {
    background: #1e40af;
    color: white;
  }

  .tab-button:hover {
    opacity: 0.9;
  }

  /* Animaci칩n suave para las tarjetas (respeta prefers-reduced-motion) */
  @media (prefers-reduced-motion: no-preference) {
    .grid > * {
      animation: fadeIn 0.5s ease-in-out;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
