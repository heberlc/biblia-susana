---
// Componente de botón avanzado para leer capítulo completo con pause
interface Props {
  text: string;
  label?: string;
  className?: string;
}

const { text, label = "Leer capítulo completo", className = "" } = Astro.props;
// Generar ID único para esta instancia
const uniqueId = `chapter-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
// Escapar el texto para JSON
const textEscaped = JSON.stringify(text);
---

<div class="inline-flex gap-3 flex-wrap" id={`controls-${uniqueId}`}>
  <button
    type="button"
    class="btn-play-chapter inline-flex items-center gap-2 px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition-colors font-semibold text-xl shadow-lg"
    id={`play-${uniqueId}`}
    aria-label={label}
  >
    <span class="text-3xl" aria-hidden="true">▶️</span>
    <span>{label}</span>
  </button>

  <button
    type="button"
    class="btn-pause-chapter hidden items-center gap-2 px-8 py-4 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 focus:ring-4 focus:ring-yellow-300 transition-colors font-semibold text-xl shadow-lg"
    id={`pause-${uniqueId}`}
    aria-label="Pausar"
  >
    <span class="text-3xl" aria-hidden="true">⏸️</span>
    <span>Pausar</span>
  </button>

  <button
    type="button"
    class="btn-resume-chapter hidden items-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors font-semibold text-xl shadow-lg"
    id={`resume-${uniqueId}`}
    aria-label="Continuar"
  >
    <span class="text-3xl" aria-hidden="true">▶️</span>
    <span>Continuar</span>
  </button>

  <button
    type="button"
    class="btn-stop-chapter hidden items-center gap-2 px-8 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 transition-colors font-semibold text-xl shadow-lg"
    id={`stop-${uniqueId}`}
    aria-label="Detener"
  >
    <span class="text-3xl" aria-hidden="true">⏹️</span>
    <span>Detener</span>
  </button>
</div>

<script is:inline data-astro-rerun define:vars={{ uniqueId, textEscaped }}>
  (function() {
    const controlsId = uniqueId;
    const chapterText = JSON.parse(textEscaped);
    
    function initControls() {
      const playBtn = document.getElementById('play-' + controlsId);
      const pauseBtn = document.getElementById('pause-' + controlsId);
      const resumeBtn = document.getElementById('resume-' + controlsId);
      const stopBtn = document.getElementById('stop-' + controlsId);
      
      if (!playBtn) return;
      
      let monitoringInterval = null;
      let chunks = [];
      let currentChunkIndex = 0;
      let isPlayingChunks = false;
      let manualPausedState = false;
      
      function updateButtons() {
        const speaking = window.speechSynthesis && window.speechSynthesis.speaking;
        const paused = manualPausedState || (window.speechSynthesis && window.speechSynthesis.paused);
        
        if (speaking && !paused) {
          playBtn.classList.add('hidden');
          pauseBtn.classList.remove('hidden');
          pauseBtn.classList.add('inline-flex');
          resumeBtn.classList.add('hidden');
          resumeBtn.classList.remove('inline-flex');
          stopBtn.classList.remove('hidden');
          stopBtn.classList.add('inline-flex');
        } else if (paused) {
          playBtn.classList.add('hidden');
          pauseBtn.classList.add('hidden');
          pauseBtn.classList.remove('inline-flex');
          resumeBtn.classList.remove('hidden');
          resumeBtn.classList.add('inline-flex');
          stopBtn.classList.remove('hidden');
          stopBtn.classList.add('inline-flex');
        } else {
          playBtn.classList.remove('hidden');
          pauseBtn.classList.add('hidden');
          pauseBtn.classList.remove('inline-flex');
          resumeBtn.classList.add('hidden');
          resumeBtn.classList.remove('inline-flex');
          stopBtn.classList.add('hidden');
          stopBtn.classList.remove('inline-flex');
        }
      }
      
      function startMonitoring() {
        if (monitoringInterval) clearInterval(monitoringInterval);
        monitoringInterval = setInterval(function() {
          updateButtons();
          if (!window.speechSynthesis.speaking && !manualPausedState) {
            clearInterval(monitoringInterval);
            monitoringInterval = null;
          }
        }, 200);
      }
      
      function speakNextChunk() {
        if (!isPlayingChunks || currentChunkIndex >= chunks.length) {
          if (currentChunkIndex >= chunks.length) {
            console.log('All chunks completed');
            isPlayingChunks = false;
            chunks = [];
            currentChunkIndex = 0;
          }
          setTimeout(function() { updateButtons(); }, 500);
          return;
        }
        
        const utterance = new SpeechSynthesisUtterance(chunks[currentChunkIndex]);
        utterance.lang = 'es-ES';
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        utterance.onstart = function() {
          console.log('Chunk', currentChunkIndex + 1, 'of', chunks.length, 'started');
        };
        
        utterance.onend = function() {
          console.log('Chunk', currentChunkIndex + 1, 'ended');
          currentChunkIndex++;
          speakNextChunk();
        };
        
        utterance.onerror = function(event) {
          console.error('Speech error on chunk', currentChunkIndex + 1, ':', event.error);
          currentChunkIndex++;
          speakNextChunk();
        };
        
        window.speechSynthesis.speak(utterance);
      }
      
      playBtn.addEventListener('click', function() {
        console.log('Play clicked, text length:', chapterText.length);
        
        if (!chapterText || !window.speechSynthesis) {
          console.error('No text or speechSynthesis not available');
          return;
        }
        
        window.speechSynthesis.cancel();
        chunks = [];
        currentChunkIndex = 0;
        isPlayingChunks = false;
        manualPausedState = false;
        
        // Si el texto es muy largo (>4000 caracteres), dividirlo
        if (chapterText.length > 4000) {
          console.log('Text too long, splitting into chunks');
          const sentences = chapterText.split(/(?<=[.!?])\s+/);
          let currentChunk = '';
          
          for (let i = 0; i < sentences.length; i++) {
            if (currentChunk.length + sentences[i].length < 3500) {
              currentChunk += (currentChunk ? ' ' : '') + sentences[i];
            } else {
              if (currentChunk) chunks.push(currentChunk);
              currentChunk = sentences[i];
            }
          }
          if (currentChunk) chunks.push(currentChunk);
          
          console.log('Total chunks:', chunks.length);
          
          isPlayingChunks = true;
          currentChunkIndex = 0;
          speakNextChunk();
          
          setTimeout(function() {
            updateButtons();
            startMonitoring();
          }, 100);
          
        } else {
          // Texto corto, leer completo
          const utterance = new SpeechSynthesisUtterance(chapterText);
          utterance.lang = 'es-ES';
          utterance.rate = 0.9;
          utterance.pitch = 1.0;
          utterance.volume = 1.0;
          
          utterance.onstart = function() {
            console.log('Speech started');
          };
          
          utterance.onerror = function(event) {
            console.error('Speech error:', event.error);
          };
          
          utterance.onend = function() {
            console.log('Speech ended');
          };
          
          window.speechSynthesis.speak(utterance);
          
          setTimeout(function() {
            updateButtons();
            startMonitoring();
          }, 100);
        }
      });
      
      pauseBtn.addEventListener('click', function() {
        console.log('Pause clicked');
        if (window.speechSynthesis && window.speechSynthesis.speaking && !manualPausedState) {
          window.speechSynthesis.pause();
          manualPausedState = true;
          console.log('Paused, manual state set to true');
          updateButtons();
        }
      });
      
      resumeBtn.addEventListener('click', function() {
        console.log('Resume clicked');
        if (window.speechSynthesis && manualPausedState) {
          window.speechSynthesis.resume();
          manualPausedState = false;
          console.log('Resumed, manual state set to false');
          updateButtons();
          startMonitoring();
        }
      });
      
      stopBtn.addEventListener('click', function() {
        console.log('Stop clicked');
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
          isPlayingChunks = false;
          chunks = [];
          currentChunkIndex = 0;
          manualPausedState = false;
          updateButtons();
          if (monitoringInterval) {
            clearInterval(monitoringInterval);
            monitoringInterval = null;
          }
        }
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initControls);
    } else {
      initControls();
    }
  })();
</script>
