---
// Componente de bot贸n para leer texto en voz alta
interface Props {
  text: string;
  label?: string;
  className?: string;
}

const { text, label = "Leer", className = "" } = Astro.props;
const uniqueId = `speech-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="flex flex-col gap-2">
  <button
    type="button"
    class="btn-speech inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition-colors font-semibold text-lg"
    data-text={text}
    data-speech-id={uniqueId}
    aria-label={`${label}: ${text.substring(0, 50)}...`}
  >
    <span class="text-2xl" aria-hidden="true"></span>
    <span>{label}</span>
  </button>

  <button
    type="button"
    class="btn-stop-speech hidden items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 transition-colors font-semibold text-lg"
    data-speech-id={uniqueId}
    aria-label="Detener audio"
  >
    <span class="text-2xl" aria-hidden="true">癸</span>
    <span>Detener</span>
  </button>
</div>

<script>
  import { speechRead, speechStop, initSpeech, isSpeaking } from '../lib/speech';

  // Inicializar Web Speech API
  initSpeech();

  let currentActiveSpeechId: string | null = null;

  // Funci贸n para actualizar el estado de los botones
  function updateButtons(activeSpeechId: string | null) {
    const speaking = isSpeaking();
    const allStopButtons = document.querySelectorAll('.btn-stop-speech');
    
    allStopButtons.forEach(btn => {
      const btnId = btn.getAttribute('data-speech-id');
      if (speaking && btnId === activeSpeechId) {
        btn.classList.remove('hidden');
        btn.classList.add('inline-flex');
      } else {
        btn.classList.add('hidden');
        btn.classList.remove('inline-flex');
      }
    });
  }
  
  // Funci贸n para resetear los botones del cap铆tulo
  function resetChapterButtons() {
    // Detener cualquier reproducci贸n de cap铆tulo
    speechStop();
    
    // Buscar todos los botones de cap铆tulo y resetear su estado
    const chapterControls = document.querySelectorAll('[id^="controls-chapter-"]');
    chapterControls.forEach(container => {
      const playBtn = container.querySelector('.btn-play-chapter');
      const pauseBtn = container.querySelector('.btn-pause-chapter');
      const resumeBtn = container.querySelector('.btn-resume-chapter');
      const stopBtn = container.querySelector('.btn-stop-chapter');
      
      playBtn?.classList.remove('hidden');
      pauseBtn?.classList.add('hidden');
      resumeBtn?.classList.add('hidden');
      stopBtn?.classList.add('hidden');
    });
    
    // Disparar evento personalizado para que ChapterSpeechButton se resetee
    window.dispatchEvent(new CustomEvent('verse-speech-started'));
  }

  // Agregar listeners a todos los botones de speech
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.btn-speech');
    const stopButtons = document.querySelectorAll('.btn-stop-speech');
    
    buttons.forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const text = target.dataset.text || target.getAttribute('data-text');
        const speechId = target.getAttribute('data-speech-id');
        
        if (text && speechId) {
          // Resetear controles del cap铆tulo antes de leer el verso
          resetChapterButtons();
          
          speechStop();
          currentActiveSpeechId = speechId;
          speechRead(text);
          
          // Esperar un momento para que comience a hablar
          setTimeout(() => {
            updateButtons(currentActiveSpeechId);
          }, 100);
          
          // Actualizar botones peri贸dicamente mientras habla
          const interval = setInterval(() => {
            updateButtons(currentActiveSpeechId);
            if (!isSpeaking()) {
              currentActiveSpeechId = null;
              updateButtons(null);
              clearInterval(interval);
            }
          }, 500);
        }
      });
    });

    stopButtons.forEach(button => {
      button.addEventListener('click', () => {
        speechStop();
        currentActiveSpeechId = null;
        updateButtons(null);
      });
    });
  });
</script>
